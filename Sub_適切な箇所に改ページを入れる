Sub 適切な箇所に改ページを入れるVer2(ByVal sheet As Worksheet)
    '作り途中
    
    Dim RPL() As Variant ' RequiredPagebreakList  必須の改ページのリスト
    Dim TARGET_COL As Integer           '対象列
    Dim LINE_CNT_PAGEBREAK As Integer   'デフォルト:50    50行数くらいで改行   それ以上にすると1ページに収まりきらない事があり、エクセルが自動で改ページを挿入してしまう
    Dim MARGIN_PAGEBREAK   As Integer   'デフォルト:20    次の改ページまで20行以上ある場合、改ページセット

    Debug.Print "============================================================================================================"
    Debug.Print "============改ページを自動で設定============================================================================"
    Debug.Print "============================================================================================================"
        
    sheet.Activate 'これ大事
    Application.ExecuteExcel4Macro "SHOW.TOOLBAR(""Ribbon"",False)"
    ActiveWindow.Zoom = 35
    'Application.DisplayFullScreen = True

    MsgBox "このマクロは SACLA運転状況集計まとめ.xlsm のシート「" & sheet.name & "」" & vbCrLf & "の適切な所に改ページいれます", Buttons:=vbInformation





'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    '自動改ページが一体何行で入るのかを確認
    Dim Auto_PB_line_cnt As Integer
    sheet.ResetAllPageBreaks ' 全ての改ページをクリア
    Set ws = sheet ' 対象のシート名を指定
    ' 水平方向の自動改ページを確認
    If ws.HPageBreaks.Count > 0 Then
        Debug.Print "水平方向の自動改ページの数: " & ws.HPageBreaks.Count
        For Each HPageBreak In ws.HPageBreaks
            If HPageBreak.Type = xlPageBreakAutomatic Then
                Debug.Print "自動改ページ（水平）位置: 行 " & HPageBreak.Location.Row
                Auto_PB_line_cnt = HPageBreak.Location.Row - 5 ' ちょっと余裕見て-5してる
            End If
            Exit For
        Next HPageBreak
    Else
        Debug.Print "水平方向の自動改ページはありません。"
    End If
    Debug.Print "自動改ページはこれを越えると入ります。 Auto_PB_line_cnt = " & Auto_PB_line_cnt
'    End
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~




    Select Case sheet.name
        Case "まとめ "
                TARGET_COL = 2  ' 対象列 B
'                 LINE_CNT_PAGEBREAK = 30   'デフォルト:50    50行数くらいで改行   それ以上にすると1ページに収まりきらない事があり、エクセルが自動で改ページを挿入してしまう
                LINE_CNT_PAGEBREAK = Auto_PB_line_cnt
                MARGIN_PAGEBREAK = 20  '　デフォルト:20    次の改ページまで20行以上ある場合、改ページセット
                'Const sheet.name As String = "まとめ "        'なんだよこれ、まとめの後ろに半角スペースが入ってるよ
                ReDim RPL(3, 1) ' 配列サイズ設定
'                RPL(0, 0) = "(a)運転時間　期間毎"
'                RPL(0, 1) = getLineNum(RPL(0, 0), TARGET_COL, sheet)
                RPL(1, 0) = "(b)運転時間　シフト毎"
                RPL(1, 1) = getLineNum(RPL(1, 0), TARGET_COL, sheet)
                RPL(2, 0) = "(c)運転条件"
                RPL(2, 1) = getLineNum(RPL(2, 0), TARGET_COL, sheet)
        Case "Fault集計"
                TARGET_COL = 2  ' 対象列 B
                LINE_CNT_PAGEBREAK = 25  'デフォルト:50    50行数くらいで改行   それ以上にすると1ページに収まりきらない事があり、エクセルが自動で改ページを挿入してしまう
                MARGIN_PAGEBREAK = 10  '　デフォルト:20    次の改ページまで20行以上ある場合、改ページセット
                'Const sheet.name As String = "Fault集計"
                ReDim RPL(2, 1) ' 配列サイズ設定
                RPL(0, 0) = "SACLA Fault間隔(BL2)"
                RPL(0, 1) = getLineNum(RPL(0, 0), TARGET_COL, sheet)
                RPL(1, 0) = "SACLA Fault間隔(BL3)"
                RPL(1, 1) = getLineNum(RPL(1, 0), TARGET_COL, sheet)
        Case Else
            Debug.Print "Zzz..."
            MsgBox "このシートでは特にやることないです。" & vbCrLf & "sheet.name:  " & sheet.name
            Call Fin
    End Select
    
    Debug.Print "sheet.Name: " & sheet.name
    Debug.Print "Last: " & Cells(Rows.Count, TARGET_COL).End(xlUp).Row
    For i = 0 To UBound(RPL, 1) - 1 ' UBound(RPL, 1)の1は行の意味。　2だと列のようだ
        Debug.Print "RPL(i, 0) : " & RPL(i, 0) & "  " & RPL(i, 1)
    Next
    
    Debug.Print "============================================================================================================"

    
    sheet.ResetAllPageBreaks ' 全ての改ページをクリア
    
'    Debug.Print "UBound(RPL, 1) : " & UBound(RPL, 1)
'    For i = 0 To UBound(RPL, 1) - 1 ' UBound(RPL, 1)の1は行の意味。　2だと列のようだ
'        Debug.Print "RPL(" & i & ", *) : 「" & RPL(i, 0) & "」   は      " & RPL(i, 1) & " 行目にあります"
'        sheet.Rows(RPL(i, 1)).PageBreak = xlPageBreakManual ' 必須の改ページをセット
'        If i = (UBound(RPL, 1) - 1) Then ' RPL配列の最後の場合
'            Call SetPagebreak(RPL(i, 1), Cells(Rows.Count, TARGET_COL).End(xlUp).Row, TARGET_COL, LINE_CNT_PAGEBREAK, sheet)
'        Else
'            Call SetPagebreak(RPL(i, 1), RPL(i + 1, 1) - 1, TARGET_COL, LINE_CNT_PAGEBREAK, sheet)
'        End If
'    Next
'
    Debug.Print "   sheet.name = " & sheet.name
    
    
    
    Dim Before_PB As Integer
    Dim line_cnt As Integer
    line_cnt = 0

    For i = 1 To sheet.UsedRange.Rows(sheet.UsedRange.Rows.Count).Row
        Debug.Print "行番号: " & i & "   line_cnt = " & line_cnt & "    Auto_PB_line_cnt = " & Auto_PB_line_cnt & "    Value: " & Cells(i, 2).Value
        
        If i = getLineNum(RPL(1, 0), TARGET_COL, sheet) Then
            Debug.Print "必須  行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value
            sheet.Rows(i).PageBreak = xlPageBreakManual
            Cells(i, TARGET_COL).Activate
            Before_PB = i
            MsgBox "   Debug:このセルの下に　必須　改ページいれました"
            line_cnt = 0
        End If
        If i = getLineNum(RPL(2, 0), TARGET_COL, sheet) Then
            Debug.Print "必須  行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value
            sheet.Rows(i).PageBreak = xlPageBreakManual
            Cells(i, TARGET_COL).Activate
            Before_PB = i
            MsgBox "   Debug:このセルの下に　必須　改ページいれました"
            line_cnt = 0
        End If

        
'        If line_cnt > LINE_CNT_PAGEBREAK Then
        
            'If IsEmpty(Cells(i, TARGET_COL).Value) And Cells(i, TARGET_COL).MergeCells Then
                'Debug.Print "セルが空っぽで、結合されている、、"
            'Else
            
                'If Cells(i, TARGET_COL).MergeCells Then  '  B列が結合されている
'                If (Not IsEmpty(Cells(i, TARGET_COL).Value) And Cells(i, TARGET_COL).MergeCells) And (line_cnt > LINE_CNT_PAGEBREAK) Then  '　セルに値が入ってて結合される場合、かつ適齢期
                If (Not IsEmpty(Cells(i, TARGET_COL).Value) And Cells(i, TARGET_COL).MergeCells) Then  '　セルに値が入ってて結合される場合、かつ適齢期
                    'Debug.Print "A  行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value & "    値が入って、結合されている     結合行：" & Cells(i, TARGET_COL).MergeArea.Rows.Count & " の下に貝"
                    Debug.Print "A  行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value & "    値が入って、結合されている"
                    '下のコードで失敗する場合、ページレイアウトから「印刷範囲のクリア」をして再度マクロを実行するとなぜかＯＫ
                    

                    If (i + Cells(i, TARGET_COL).MergeArea.Rows.Count - Before_PB) > Auto_PB_line_cnt Then
                        Debug.Print "Overしちゃうのでここに改ページ " & i & "       Before_PB = " & Before_PB & "    Value: " & Cells(i, 2).Value
                        sheet.Rows(i).PageBreak = xlPageBreakManual  '  2より大きくないとCells(i, 2).MergeArea.Rows.Countで、エラー　　　2だと2行目の上に引かれる
                        Cells(i, TARGET_COL).Activate
                        If MsgBox("Debug:このセルの下に　A　改ページいれました" & vbCrLf & "次に進むにはYes", vbYesNo + vbQuestion, "確認") = vbNo Then Exit Sub
                        line_cnt = 0
                        Before_PB = i
                    
                    ElseIf line_cnt > LINE_CNT_PAGEBREAK Then
                        Debug.Print "Overしないので、 " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value & "    値が入って、結合されている     結合行：" & Cells(i, TARGET_COL).MergeArea.Rows.Count & " の下に貝" & "   Before_PB = " & Before_PB
                        'Debug.Print "Not Over: " & i & "   Before_PB = " & Before_PB & "    Value: " & Cells(i, 2).Value
                        i = i + Cells(i, TARGET_COL).MergeArea.Rows.Count
                        sheet.Rows(i).PageBreak = xlPageBreakManual  '  2より大きくないとCells(i, 2).MergeArea.Rows.Countで、エラー　　　2だと2行目の上に引かれる
                        Cells(i, TARGET_COL).Activate
                        If MsgBox("Debug:このセルの下に　a　改ページいれました" & vbCrLf & "次に進むにはYes", vbYesNo + vbQuestion, "確認") = vbNo Then Exit Sub
                        line_cnt = 0
                        Before_PB = i
                    
                    End If
                    
                
                End If



                If (Not Cells(i, TARGET_COL).MergeCells) And line_cnt > LINE_CNT_PAGEBREAK Then  '　セルが結合されてなくて、かつ適齢期
                    Debug.Print "B  行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value & "    値が入ってなくて、結合されてない　貝: i = " & i
                            
                    sheet.Rows(i).PageBreak = xlPageBreakManual
                    
                    Cells(i, TARGET_COL).Activate
                    If MsgBox("Debug:このセルの下に　B　改ページいれました" & vbCrLf & "次に進むにはYes", vbYesNo + vbQuestion, "確認") = vbNo Then Exit Sub
                            
                    line_cnt = 0
                    Before_PB = i
                            
                End If
                
                
            'End If

'        End If
        
        line_cnt = line_cnt + 1
    Next
    
    
    
    sheet.DisplayPageBreaks = True
   
'    If MsgBox("終了。プレビュー表示しますか？", vbYesNo + vbQuestion, "確認") = vbYes Then
'        sheet.PrintPreview
'    End If

    MsgBox "終了しました。シート「" & sheet.name & "」" & vbCrLf & "の適切な所に改ページいれました", Buttons:=vbInformation
    Call Fin
    Debug.Print "Fin================================================================================================================="
    
End Sub


















'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Sub 適切な箇所に改ページを入れる(ByVal sheet As Worksheet)
    
    Dim RPL() As Variant ' RequiredPagebreakList  必須の改ページのリスト
    Dim TARGET_COL As Integer           '対象列
    Dim LINE_CNT_PAGEBREAK As Integer   'デフォルト:50    50行数くらいで改行   それ以上にすると1ページに収まりきらない事があり、エクセルが自動で改ページを挿入してしまう
    Dim MARGIN_PAGEBREAK   As Integer   'デフォルト:20    次の改ページまで20行以上ある場合、改ページセット

    Debug.Print "============================================================================================================"
    Debug.Print "============改ページを自動で設定============================================================================"
    Debug.Print "============================================================================================================"
        
    sheet.Activate 'これ大事
    Application.ExecuteExcel4Macro "SHOW.TOOLBAR(""Ribbon"",False)"
    ActiveWindow.Zoom = 35
    'Application.DisplayFullScreen = True

    MsgBox "このマクロは SACLA運転状況集計まとめ.xlsm のシート「" & sheet.name & "」" & vbCrLf & "の適切な所に改ページいれます", Buttons:=vbInformation


    Select Case sheet.name
        Case "まとめ "
                TARGET_COL = 2  ' 対象列 B
                LINE_CNT_PAGEBREAK = 30   'デフォルト:50    50行数くらいで改行   それ以上にすると1ページに収まりきらない事があり、エクセルが自動で改ページを挿入してしまう
                MARGIN_PAGEBREAK = 20  '　デフォルト:20    次の改ページまで20行以上ある場合、改ページセット
                'Const sheet.name As String = "まとめ "        'なんだよこれ、まとめの後ろに半角スペースが入ってるよ
                ReDim RPL(3, 1) ' 配列サイズ設定
                RPL(0, 0) = "(a)運転時間　期間毎"
                RPL(0, 1) = getLineNum(RPL(0, 0), TARGET_COL, sheet)
                RPL(1, 0) = "(b)運転時間　シフト毎"
                RPL(1, 1) = getLineNum(RPL(1, 0), TARGET_COL, sheet)
                RPL(2, 0) = "(c)運転条件"
                RPL(2, 1) = getLineNum(RPL(2, 0), TARGET_COL, sheet)
        Case "Fault集計"
                TARGET_COL = 2  ' 対象列 B
                LINE_CNT_PAGEBREAK = 25  'デフォルト:50    50行数くらいで改行   それ以上にすると1ページに収まりきらない事があり、エクセルが自動で改ページを挿入してしまう
                MARGIN_PAGEBREAK = 10  '　デフォルト:20    次の改ページまで20行以上ある場合、改ページセット
                'Const sheet.name As String = "Fault集計"
                ReDim RPL(2, 1) ' 配列サイズ設定
                RPL(0, 0) = "SACLA Fault間隔(BL2)"
                RPL(0, 1) = getLineNum(RPL(0, 0), TARGET_COL, sheet)
                RPL(1, 0) = "SACLA Fault間隔(BL3)"
                RPL(1, 1) = getLineNum(RPL(1, 0), TARGET_COL, sheet)
        Case Else
            Debug.Print "Zzz..."
            MsgBox "このシートでは特にやることないです。" & vbCrLf & "sheet.name:  " & sheet.name
            Call Fin
    End Select
    
    Debug.Print "sheet.Name: " & sheet.name
    Debug.Print "Last: " & Cells(Rows.Count, TARGET_COL).End(xlUp).Row
    For i = 0 To UBound(RPL, 1) - 1 ' UBound(RPL, 1)の1は行の意味。　2だと列のようだ
        Debug.Print "RPL(i, 0) : " & RPL(i, 0) & "  " & RPL(i, 1)
    Next
    
    Debug.Print "============================================================================================================"

    
    sheet.ResetAllPageBreaks ' 全ての改ページをクリア
    
'    Debug.Print "UBound(RPL, 1) : " & UBound(RPL, 1)
    For i = 0 To UBound(RPL, 1) - 1 ' UBound(RPL, 1)の1は行の意味。　2だと列のようだ
        Debug.Print "RPL(" & i & ", *) : 「" & RPL(i, 0) & "」   は      " & RPL(i, 1) & " 行目にあります"
        sheet.Rows(RPL(i, 1)).PageBreak = xlPageBreakManual ' 必須の改ページをセット
        If i = (UBound(RPL, 1) - 1) Then ' RPL配列の最後の場合
            Call SetPagebreak(RPL(i, 1), Cells(Rows.Count, TARGET_COL).End(xlUp).Row, TARGET_COL, LINE_CNT_PAGEBREAK, sheet)
        Else
            Call SetPagebreak(RPL(i, 1), RPL(i + 1, 1) - 1, TARGET_COL, LINE_CNT_PAGEBREAK, sheet)
        End If
    Next
    
    
    For p = 1 To sheet.HPageBreaks.Count
        Debug.Print "Page = " & p & "   sheet.HPageBreaks(p).Location.Row = " & sheet.HPageBreaks(p).Location.Row
    Next p
    
    Debug.Print "~~~~~~~~~~~~~~~~~~~~~    とりあえずのトータルの改ページ数：" & sheet.HPageBreaks.Count
    Debug.Print "~~~~~~~~~~~~~~~~~~~~~    必須の改ページ数： " & UBound(RPL, 1)
    
      
    
      
    Debug.Print "============================================================================================================"
    Debug.Print "===改ページの行数と必須かどうかを2次元配列PagebreakListに格納して、それを基に改めて改ページをセットし直す==="
    Debug.Print "============================================================================================================"
    
    Dim PagebreakList() As Integer
    ReDim PagebreakList(sheet.HPageBreaks.Count, 1) '配列サイズ設定
    
    

    
    '改ページの行数と必須かどうかを2次元配列PagebreakListに格納
    Dim totalP As Integer
    totalP = 0
    For p = 1 To sheet.HPageBreaks.Count
        'Debug.Print "Page = " & p & "   sheet.HPageBreaks(p).Location.Row = " & sheet.HPageBreaks(p).Location.Row
        
        If sheet.HPageBreaks(p).Location.Row > MARGIN_PAGEBREAK Then  'セットする改ページが MARGIN_PAGEBREAK 行より下の場合、改ページセット
            PagebreakList(totalP, 0) = sheet.HPageBreaks(p).Location.Row
            PagebreakList(totalP, 1) = 0  'とりあえず、必須でない改ページ:0を入れとく
            
            For i = 0 To UBound(RPL, 1) - 1 ' UBound(RPL, 1)の1は行の意味。　2だと列のようだ
                If sheet.HPageBreaks(p).Location.Row = RPL(i, 1) Then
                    'Debug.Print "必須RPL(i, 0) = " & RPL(i, 0) & "  RPL(i, 1)=" & RPL(i, 1) & " sheet.HPageBreaks(p).Location.Row= " & sheet.HPageBreaks(p).Location.Row
                    PagebreakList(totalP, 1) = 1 '必須の改ページのところにフラグ:1を立てる
                End If
            Next
        
            Debug.Print "* PagebreakList " & totalP & ":    " & PagebreakList(totalP, 0) & "   行目      必須フラグ: " & PagebreakList(totalP, 1)
            totalP = totalP + 1
        End If
            
    Next p
    
    
    
    
    'End 'for DEBUG
    
    
    '一旦改ページを削除
    sheet.ResetAllPageBreaks
    
    
    'PagebreakListを基に改めて改ページをセットし直す
    For i = 0 To UBound(PagebreakList, 1) - 1
        'Debug.Print ">PagebreakList(" & i; ",):   " & PagebreakList(i, 0) & "  " & PagebreakList(i, 1)
    
        If (PagebreakList(i + 1, 0) - PagebreakList(i, 0)) > MARGIN_PAGEBREAK Then   '次の改ページまで MARGIN_PAGEBREAK 行以上ある場合、改ページセット
            sheet.Rows(PagebreakList(i, 0)).PageBreak = xlPageBreakManual
            Debug.Print "Set PagebreakList(" & i & ", 0" & "):   " & PagebreakList(i, 0) & "  Next: " & PagebreakList(i + 1, 0)
            
            
            sheet.Rows(PagebreakList(i, 0)).Select
            MsgBox "Debug   このセルの下に改ページセット", Buttons:=vbInformation


        End If
    
        If (PagebreakList(i, 1)) = 1 Then  '必須の改ページの場合、改ページセット
            sheet.Rows(PagebreakList(i, 0)).PageBreak = xlPageBreakManual
            Debug.Print "Set Required PagebreakList(" & i & ", 0" & "):   " & PagebreakList(i, 0) & "  Next: " & PagebreakList(i + 1, 0)
       
            sheet.Rows(PagebreakList(i, 0)).Select
            MsgBox "Debug   このセルの下に　必須　改ページセット", Buttons:=vbInformation

        End If
        
    Next
    
    
    
    
    sheet.DisplayPageBreaks = True
   
'    If MsgBox("終了。プレビュー表示しますか？", vbYesNo + vbQuestion, "確認") = vbYes Then
'        sheet.PrintPreview
'    End If

    MsgBox "終了しました。シート「" & sheet.name & "」" & vbCrLf & "の適切な所に改ページいれました", Buttons:=vbInformation
    Call Fin
    Debug.Print "Fin================================================================================================================="
    
    

End Sub

















'改行は***行ごとくらいでいれる==============================================================================================================================
Function SetPagebreak(ByVal startLine As Integer, ByVal endLine As Integer, ByVal TARGET_COL As Integer, ByVal LINE_CNT_PAGEBREAK As Integer, ByVal sheetname As Worksheet)
    'Debug.Print "SetPagebreak~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~startLine = "; startLine & "       endLine: " & endLine
    If (endLine - startLine) <= 0 Then
        MsgBox "引数異常"
        End
    End If

    Dim line_cnt As Integer
    line_cnt = 0

    For i = startLine To endLine
        'Debug.Print "行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value
        
        If line_cnt > LINE_CNT_PAGEBREAK Then
        
            If IsEmpty(Cells(i, TARGET_COL).Value) And Cells(i, TARGET_COL).MergeCells Then
                'Debug.Print "セルが空っぽで、結合されている、、"
            Else
            
                If Cells(i, TARGET_COL).MergeCells Then  '  B列が結合されている
                    Debug.Print "行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value & "    値が入って、結合されている     結合行：" & Cells(i, TARGET_COL).MergeArea.Rows.Count & " の下に貝"
                    
'                    Cells(i, TARGET_COL).Activate
'                    MsgBox "A   Debug:このセルの下に改ページいれます"
                    
                    '下のコードで失敗する場合、ページレイアウトから「印刷範囲のクリア」をして再度マクロを実行するとなぜかＯＫ
                    sheetname.Rows(i + Cells(i, 2).MergeArea.Rows.Count).PageBreak = xlPageBreakManual  '  2より大きくないとCells(i, 2).MergeArea.Rows.Countで、エラー　　　2だと2行目の上に引かれる
                Else
                    Debug.Print "行番号: " & i & "   line_cnt = " & line_cnt & "    Value: " & Cells(i, 2).Value & "    値が入ってなくて、結合されてない　貝: i = " & i
                    
'                    Cells(i, TARGET_COL).Activate
'                    MsgBox "B   Debug:このセルの下に改ページいれます"
                    
                            
                    sheetname.Rows(i).PageBreak = xlPageBreakManual
                    
                End If
                line_cnt = 0
            
            End If

        End If
        
        line_cnt = line_cnt + 1
    Next

End Function






